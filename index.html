<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·´çˆ¾å¹¹åŠå³¶17æ—¥å†¬éŠäº’å‹•æŒ‡å—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFBF7;
            color: #2D3748;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        .chart-container {
            position: relative;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            height: 250px; /* Mobile height */
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px; /* Desktop height */
                max-width: 600px;
            }
        }
        /* Hide scrollbar for clean horizontal scrolling */
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .day-card.active-day {
            border-color: #F97316; /* orange-500 */
            background-color: #FFF7ED; /* orange-50 */
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.2);
            transform: scale(1.05);
        }
        /* Mobile Bottom Nav Styles */
        .bottom-nav-item {
            position: relative;
            transition: all 0.2s;
        }
        .bottom-nav-item.active {
            color: #C05621;
        }
        .bottom-nav-item.active::after {
            content: '';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background-color: #C05621;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        /* AI Chat Bubbles */
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            line-height: 1.5;
            font-size: 0.95rem;
        }
        .chat-user {
            background-color: #FEEBC8; /* Orange-100 */
            color: #7B341E;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-ai {
            background-color: #EBF8FF; /* Blue-100 */
            color: #2C5282;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; }
        .markdown-body p { margin-bottom: 0.5em; }
        .loading-dots::after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ' ....'; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen pb-20 md:pb-0">

    <!-- Top Header (Simplified for Mobile) -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-center md:justify-between">
            <div class="flex items-center space-x-2">
                <span class="text-xl md:text-2xl font-bold text-orange-700">ğŸ‡§ğŸ‡¬ å·´çˆ¾å¹¹å†¬éŠ</span>
            </div>
            <!-- Desktop Nav (Hidden on Mobile) -->
            <div class="hidden md:flex space-x-6">
                <button onclick="switchTab('dashboard')" class="desktop-nav-item px-3 py-2 text-sm font-medium hover:text-orange-700 transition" data-target="dashboard">ç¸½è¦½</button>
                <button onclick="switchTab('itinerary')" class="desktop-nav-item px-3 py-2 text-sm font-medium hover:text-orange-700 transition" data-target="itinerary">è¡Œç¨‹</button>
                <button onclick="switchTab('souvenirs')" class="desktop-nav-item px-3 py-2 text-sm font-medium hover:text-orange-700 transition" data-target="souvenirs">ä¼´æ‰‹ç¦®</button>
                <button onclick="switchTab('ai-assistant')" class="desktop-nav-item px-3 py-2 text-sm font-medium hover:text-orange-700 transition text-purple-600 font-bold" data-target="ai-assistant">âœ¨ AI å°éŠ</button>
                <button onclick="switchTab('analytics')" class="desktop-nav-item px-3 py-2 text-sm font-medium hover:text-orange-700 transition" data-target="analytics">åˆ†æ</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 py-6 w-full overflow-hidden">

        <!-- DASHBOARD SECTION -->
        <div id="dashboard" class="tab-content active space-y-6">
            <div class="text-center space-y-2">
                <h1 class="text-2xl md:text-4xl font-bold text-gray-800">17 å¤©å†¬éŠæŒ‡å—</h1>
                <p class="text-sm md:text-xl text-gray-600">12/18 - 1/3 | è–èª•è·¨å¹´ç‰¹åˆ¥åœ˜</p>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 flex flex-col items-center justify-center">
                        <span class="text-2xl font-bold text-orange-700">9 åœ‹</span>
                        <span class="text-xs text-orange-800 opacity-75">æ¢ç´¢åœ‹å®¶</span>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 flex flex-col items-center justify-center">
                        <span class="text-2xl font-bold text-blue-700">-5Â°C</span>
                        <span class="text-xs text-blue-800 opacity-75">å¹³å‡ä½æº«</span>
                    </div>
                    <div class="bg-green-50 p-3 rounded-xl border border-green-100 flex flex-col items-center justify-center">
                        <span class="text-2xl font-bold text-green-700">8 äºº</span>
                        <span class="text-xs text-green-800 opacity-75">è¦ªå‹åœ˜</span>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-xl border border-purple-100 flex flex-col items-center justify-center">
                        <span class="text-2xl font-bold text-purple-700">5+</span>
                        <span class="text-xs text-purple-800 opacity-75">è²¨å¹£ç¨®é¡</span>
                    </div>
                </div>
            </div>

            <!-- Winter Survival Kit -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="bg-blue-600 px-4 py-3 flex justify-between items-center">
                    <h2 class="text-white font-bold flex items-center">
                        â„ï¸ è¡Œå‰æª¢æ ¸è¡¨
                    </h2>
                    <span class="text-xs text-blue-100 bg-blue-700 px-2 py-1 rounded-full" id="progress-text">0/8</span>
                </div>
                <div class="p-4">
                    <div class="grid gap-3" id="checklist-container">
                        <!-- JS populated -->
                    </div>
                    <div class="mt-4 p-3 bg-yellow-50 rounded-lg text-xs text-yellow-800 border border-yellow-100 flex items-start">
                        <span class="mr-2 text-lg">ğŸ’¡</span>
                        <span><strong>æ´‹è”¥å¼ç©¿æ³•ï¼š</strong>è»Šå…§æš–æ°£ç´„20Â°C+ã€‚å…§ç©¿è–„é•·è¢–ï¼Œå¤–ç½©é˜²é¢¨åšå¤–å¥—ï¼Œæ–¹ä¾¿ç©¿è„«ã€‚</span>
                    </div>
                </div>
            </div>

            <!-- Quick Tips Scroller -->
            <div>
                <h3 class="font-bold text-gray-700 mb-2 px-1">é€ŸæŸ¥å°å¹«æ‰‹</h3>
                <div class="flex overflow-x-auto space-x-4 pb-2 hide-scroll -mx-4 px-4">
                    <div class="flex-shrink-0 w-64 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="text-xl mb-1">ğŸŒ æ—¥ç…§æé†’</div>
                        <p class="text-sm text-gray-500">ä¸‹åˆ <strong>4:00</strong> å¤©é»‘ã€‚è¡Œç¨‹æ—©å‡ºæ—©æ­¸ï¼Œæ™šä¸Šå¯é€›è¶…å¸‚ã€‚</p>
                    </div>
                    <div class="flex-shrink-0 w-64 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="text-xl mb-1">ğŸ’Š å‚™è—¥æ¸…å–®</div>
                        <p class="text-sm text-gray-500">æšˆè»Šè—¥(å±±è·¯å¤š)ã€æ„Ÿå†’/è…¸èƒƒè—¥ã€‚å¸¶ä¹³æ¶²è­·å”‡è†ã€‚</p>
                    </div>
                    <div class="flex-shrink-0 w-64 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="text-xl mb-1">ğŸ”Œ é›»å£“æ’åº§</div>
                        <p class="text-sm text-gray-500">é›™å­”åœ“å½¢ (220V)ã€‚è‡ªå‚™è¬ç”¨è½‰æ¥é ­ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ITINERARY SECTION -->
        <div id="itinerary" class="tab-content space-y-4">
            <div class="flex justify-between items-end px-1">
                <h2 class="text-xl font-bold text-gray-800">ğŸ“… æ¯æ—¥è¡Œç¨‹</h2>
                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">å·¦å³æ»‘å‹•é¸æ“‡</span>
            </div>
            
            <!-- Timeline Navigation (Horizontal Scroll) -->
            <div class="sticky top-0 bg-[#FDFBF7] pt-2 pb-4 z-10 -mx-4 px-4 overflow-hidden">
                <div class="flex overflow-x-auto space-x-3 hide-scroll scroll-smooth" id="timeline-scroll">
                    <!-- JS will populate timeline days -->
                </div>
            </div>

            <!-- Day Detail View -->
            <div id="day-detail" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden min-h-[400px]">
                <!-- Dynamic Content -->
                <div class="flex items-center justify-center h-full text-gray-400">
                    è¼‰å…¥ä¸­...
                </div>
            </div>
        </div>

        <!-- SOUVENIRS & CUSTOMS SECTION -->
        <div id="souvenirs" class="tab-content space-y-6">
            <!-- Customs Checker -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="bg-red-50 p-4 border-b border-red-100">
                    <h2 class="text-lg font-bold text-red-800 flex items-center">
                        <span class="text-xl mr-2">ğŸš¨</span> å°ç£æµ·é—œç´…ç¶ ç‡ˆ
                    </h2>
                    <p class="text-xs text-red-600 mt-1">é»æ“Šç‰©å“æŸ¥çœ‹æ˜¯å¦å¯å¸¶å›åœ‹</p>
                </div>
                
                <div class="p-4">
                    <div class="flex flex-wrap gap-2 mb-4" id="customs-filters">
                        <!-- Filters generated by JS -->
                    </div>
                    <div id="customs-result" class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center transition-all duration-300">
                        <span class="text-gray-400 text-sm">è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æª¢æŸ¥</span>
                    </div>
                </div>
            </div>

            <!-- Souvenirs List -->
            <div>
                <div class="flex justify-between items-center mb-3 px-1">
                    <h2 class="text-xl font-bold text-gray-800">ğŸ›ï¸ å¿…è²·æ¨è–¦</h2>
                </div>
                
                <!-- Horizontal Filter Scroll -->
                <div class="flex overflow-x-auto space-x-2 pb-4 hide-scroll -mx-4 px-4 mb-2">
                     <button onclick="filterSouvenirs('all')" class="flex-shrink-0 px-4 py-2 rounded-full bg-gray-200 text-xs font-bold transition active-souvenir-filter text-gray-700" id="filter-all">å…¨éƒ¨</button>
                     <button onclick="filterSouvenirs('ä¿åŠ åˆ©äº')" class="flex-shrink-0 px-4 py-2 rounded-full bg-gray-100 text-xs font-medium transition text-gray-600" id="filter-ä¿åŠ åˆ©äº">ä¿åŠ åˆ©äº</button>
                     <button onclick="filterSouvenirs('ç¾…é¦¬å°¼äº')" class="flex-shrink-0 px-4 py-2 rounded-full bg-gray-100 text-xs font-medium transition text-gray-600" id="filter-ç¾…é¦¬å°¼äº">ç¾…é¦¬å°¼äº</button>
                     <button onclick="filterSouvenirs('å…‹ç¾…åŸƒè¥¿äº')" class="flex-shrink-0 px-4 py-2 rounded-full bg-gray-100 text-xs font-medium transition text-gray-600" id="filter-å…‹ç¾…åŸƒè¥¿äº">å…‹ç¾…åŸƒè¥¿äº</button>
                     <button onclick="filterSouvenirs('é¦¬å…¶é “')" class="flex-shrink-0 px-4 py-2 rounded-full bg-gray-100 text-xs font-medium transition text-gray-600" id="filter-é¦¬å…¶é “">é¦¬å…¶é “</button>
                </div>

                <div class="grid grid-cols-1 gap-4" id="souvenir-grid">
                    <!-- JS Populates Souvenirs -->
                </div>
            </div>
        </div>

        <!-- AI ASSISTANT SECTION (NEW) -->
        <div id="ai-assistant" class="tab-content space-y-6">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 rounded-b-3xl shadow-md -mx-4 mb-4 text-white">
                <h2 class="text-2xl font-bold mb-2">âœ¨ AI éš¨èº«å°éŠ</h2>
                <p class="text-purple-100 text-sm">ç”± Google Gemini é©…å‹•ï¼Œç‚ºæ‚¨è§£ç­”æ—…é€”ç–‘å•èˆ‡æ¨è–¦é€ç¦®éˆæ„Ÿã€‚</p>
            </div>

            <!-- AI Feature Switcher -->
            <div class="flex space-x-2 bg-gray-100 p-1 rounded-xl mx-1">
                <button onclick="switchAIMode('chat')" id="btn-ai-chat" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow text-purple-700 transition">ğŸ’¬ å•å•å°éŠ</button>
                <button onclick="switchAIMode('gift')" id="btn-ai-gift" class="flex-1 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-white/50 transition">ğŸ ä¼´æ‰‹ç¦®æ™ºå›Š</button>
            </div>

            <!-- Feature 1: Chat with Guide -->
            <div id="ai-mode-chat" class="space-y-4">
                <div id="chat-history" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 h-[400px] overflow-y-auto flex flex-col">
                    <!-- Welcome Message -->
                    <div class="chat-bubble chat-ai">
                        å—¨ï¼æˆ‘æ˜¯æ‚¨çš„ AI å°éŠã€‚é€™è¶Ÿå·´çˆ¾å¹¹ 17 å¤©ä¹‹æ—…æœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼<br>ä¾‹å¦‚ï¼šã€ŒåŒˆç‰™åˆ©è¦çµ¦å¤šå°‘å°è²»ï¼Ÿã€ã€ã€Œå¸ƒæœ—åŸå ¡æœ‰ä»€éº¼æ•…äº‹ï¼Ÿã€
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..." class="flex-grow p-3 rounded-xl border border-gray-300 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition">
                    <button onclick="handleChat()" class="bg-purple-600 text-white p-3 rounded-xl hover:bg-purple-700 transition shadow-md disabled:bg-gray-400" id="chat-submit">
                        â¤
                    </button>
                </div>
            </div>

            <!-- Feature 2: Gift Recommender -->
            <div id="ai-mode-gift" class="space-y-4 hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center"><span class="text-xl mr-2">ğŸ</span> èª°æ˜¯å¹¸é‹å…’ï¼Ÿ</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é€ç¦®å°è±¡</label>
                            <input type="text" id="gift-recipient" placeholder="ä¾‹å¦‚ï¼šå–œæ­¡åšèœçš„åª½åª½ã€æŒ‘å‰”çš„ä¸»ç®¡..." class="w-full p-3 rounded-xl border border-gray-200 focus:border-purple-500 outline-none bg-gray-50">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åœ‹å®¶/åœ°å€ (å¯é¸)</label>
                            <select id="gift-country" class="w-full p-3 rounded-xl border border-gray-200 focus:border-purple-500 outline-none bg-gray-50">
                                <option value="å…¨è¡Œç¨‹">å…¨è¡Œç¨‹ (ä¹åœ‹)</option>
                                <option value="ä¿åŠ åˆ©äº">ä¿åŠ åˆ©äº (ç«ç‘°)</option>
                                <option value="ç¾…é¦¬å°¼äº">ç¾…é¦¬å°¼äº</option>
                                <option value="åŒˆç‰™åˆ©">åŒˆç‰™åˆ©</option>
                                <option value="å…‹ç¾…åŸƒè¥¿äº">å…‹ç¾…åŸƒè¥¿äº</option>
                                <option value="é¦¬å…¶é “">é¦¬å…¶é “</option>
                            </select>
                        </div>

                        <button onclick="recommendGift()" id="gift-submit" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 rounded-xl shadow-md hover:opacity-90 transition flex justify-center items-center">
                            âœ¨ ç”Ÿæˆæ¨è–¦æ¸…å–®
                        </button>
                    </div>
                </div>

                <div id="gift-result" class="hidden bg-white rounded-2xl shadow-sm border border-purple-100 p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                    <h4 class="font-bold text-purple-800 mb-2">ğŸ’¡ AI æ¨è–¦å»ºè­°ï¼š</h4>
                    <div id="gift-content" class="text-sm text-gray-700 markdown-body leading-relaxed space-y-2">
                        <!-- Result goes here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALYTICS SECTION -->
        <div id="analytics" class="tab-content space-y-6">
            <h2 class="text-xl font-bold text-gray-800 px-1">ğŸ“Š æ—…ç¨‹æ•¸æ“š</h2>
            
            <!-- Temperature Chart -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-700 mb-2 flex items-center">
                    <span class="mr-2">ğŸŒ¡ï¸</span> æ¯æ—¥æ°£æº«é æ¸¬
                </h3>
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>

            <!-- Currency Chart -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-sm font-bold text-gray-700 mb-2 flex items-center">
                    <span class="mr-2">ğŸ’°</span> è²¨å¹£ä½¿ç”¨å¤©æ•¸
                </h3>
                <div class="chart-container">
                    <canvas id="currencyChart"></canvas>
                </div>
            </div>

            <!-- Fun Facts -->
            <div class="bg-orange-50 p-5 rounded-xl border border-orange-100">
                <h3 class="font-bold text-orange-800 mb-3 text-sm">ğŸ§ å·´çˆ¾å¹¹å†·çŸ¥è­˜</h3>
                <ul class="space-y-3 text-sm text-gray-700">
                    <li class="flex items-start">
                        <span class="mr-2 text-orange-500">â€¢</span>
                        <span><strong>æ–é ­ Yes é»é ­ Noï¼š</strong> ä¿åŠ åˆ©äºå‚³çµ±è‚¢é«”èªè¨€èˆ‡æˆ‘å€‘ç›¸åï¼Œå°å¿ƒèª¤æœƒï¼</span>
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2 text-orange-500">â€¢</span>
                        <span><strong>å…©å€‹è–èª•ç¯€ï¼š</strong> ç¾…é¦¬å°¼äºé 12/25ï¼Œé¦¬å…¶é “/å¡çˆ¾ç¶­äºé 1/7ã€‚</span>
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2 text-orange-500">â€¢</span>
                        <span><strong>æ³¢å£«å°¼äºå’–å•¡ï¼š</strong> å–æ³•æ˜¯å…ˆæŠŠæ–¹ç³–å’¬ä¸€å£å«è‘—ï¼Œå†å–å’–å•¡ã€‚</span>
                    </li>
                </ul>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation Bar (Mobile Only) -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe z-50">
        <div class="flex justify-around items-center h-16">
            <button onclick="switchTab('dashboard')" class="bottom-nav-item active w-full h-full flex flex-col items-center justify-center text-gray-400" data-target="dashboard">
                <span class="text-xl mb-1">ğŸ </span>
                <span class="text-[10px] font-medium">ç¸½è¦½</span>
            </button>
            <button onclick="switchTab('itinerary')" class="bottom-nav-item w-full h-full flex flex-col items-center justify-center text-gray-400" data-target="itinerary">
                <span class="text-xl mb-1">ğŸ“…</span>
                <span class="text-[10px] font-medium">è¡Œç¨‹</span>
            </button>
            <button onclick="switchTab('souvenirs')" class="bottom-nav-item w-full h-full flex flex-col items-center justify-center text-gray-400" data-target="souvenirs">
                <span class="text-xl mb-1">ğŸ›ï¸</span>
                <span class="text-[10px] font-medium">ä¼´æ‰‹ç¦®</span>
            </button>
            <button onclick="switchTab('ai-assistant')" class="bottom-nav-item w-full h-full flex flex-col items-center justify-center text-gray-400" data-target="ai-assistant">
                <span class="text-xl mb-1 text-purple-600">âœ¨</span>
                <span class="text-[10px] font-medium text-purple-600">AI å°éŠ</span>
            </button>
            <button onclick="switchTab('analytics')" class="bottom-nav-item w-full h-full flex flex-col items-center justify-center text-gray-400" data-target="analytics">
                <span class="text-xl mb-1">ğŸ“Š</span>
                <span class="text-[10px] font-medium">åˆ†æ</span>
            </button>
        </div>
    </nav>

    <!-- JavaScript Logic -->
    <script>
        // --- DATA STORAGE ---
        const itineraryData = [
            { day: 1, date: "12/18", country: "å‡ºç™¼", loc: "æ¡ƒåœ’ âœˆï¸ åŒ—äº¬", tempH: 20, tempL: 15, weather: "æ©Ÿä¸Š", desc: "é•·é€”é£›è¡Œå»ºè­°ç©¿è‘—å¯¬é¬†èˆ’é©ã€‚ä¿æº«ç“¶è«‹åœ¨éå®‰æª¢å¾Œè£æ°´ã€‚", tips: "å¸¶è‘—æ„‰å¿«å¿ƒæƒ…å‡ºç™¼ï¼", gift: "" },
            { day: 2, date: "12/19", country: "åŒˆç‰™åˆ©", loc: "å¸ƒé”ä½©æ–¯ â å¡æ ¼å¾·", tempH: 4, tempL: -2, weather: "å¯’å†·", desc: "åƒè§€å¸ƒé”çš‡å®®ã€è‹±é›„å»£å ´ã€‚æ³¨æ„åŒˆç‰™åˆ©å–å•¤é…’ã€ä¸æ•²æ¯ã€çš„å‚³çµ±ç¦å¿Œã€‚", tips: "è²¨å¹£ï¼šç¦æ— (HUF)ã€‚", gift: "ç´…æ¤’ç²‰ã€éµè‚é†¬(éœ€å…¨ç†Ÿ)ã€è²´è…é…’ã€åˆºç¹¡" },
            { day: 3, date: "12/20", country: "ç¾…é¦¬å°¼äº", loc: "è’‚ç±³ç”šç“¦æ‹‰ â éŒ«æ¯”çƒ", tempH: 3, tempL: -3, weather: "å†·/å±±å€", desc: "è’‚ç±³ç”šç“¦æ‹‰æœ‰å°ç¶­ä¹Ÿç´ä¹‹ç¨±ã€‚éŒ«æ¯”çƒå±‹é ‚æœ‰ã€çœ¼ç›ã€æ°£çª—ã€‚", tips: "é€²å…¥ç¾…é¦¬å°¼äºï¼Œä½¿ç”¨åˆ—ä¼Š (RON)ã€‚è·¨åœ‹ç•Œéœ€è€å¿ƒã€‚", gift: "Gerovital ä¿é¤Šå“ã€é‡è“æœé†¬ã€èœ‚èœœ" },
            { day: 4, date: "12/21", country: "ç¾…é¦¬å°¼äº", loc: "éŒ«æ¯”çƒ â å¸ƒæ‹‰ç´¢å¤«", tempH: 0, tempL: -5, weather: "é›ª/å†·", desc: "é€ è¨ªå¾·å¤æ‹‰(å¸ƒæœ—)åŸå ¡ã€‚å±±å€å¯’å†·å¯èƒ½æœ‰é›ªï¼Œåƒè§€æ•™å ‚è«‹è„«å¸½ã€‚", tips: "ä»Šæ—¥è·¯ç¨‹è¼ƒå¤šå±±è·¯ï¼Œå‚™å¦¥æšˆè»Šè—¥ã€‚", gift: "Horezu é™¶ç“·ã€å¸è¡€é¬¼å‘¨é‚Šã€æ¢…å­ç™½è˜­åœ°" },
            { day: 5, date: "12/22", country: "ç¾…é¦¬å°¼äº", loc: "å¸ƒæ‹‰ç´¢å¤« â å¸ƒåŠ å‹’æ–¯ç‰¹", tempH: 5, tempL: -1, weather: "å¯’å†·", desc: "åƒè§€ä¸–ç•Œç¬¬äºŒå¤§å»ºç¯‰ã€äººæ°‘å®®ã€ã€‚æ³¨æ„å¤§åŸå¸‚äººå¤šï¼ŒèƒŒåŒ…å‰èƒŒé˜²æ‰’æ‰‹ã€‚", tips: "é€±æ—¥å¸‚å€äº¤é€šé †æš¢ï¼Œä½†å•†åº—å¯èƒ½æ—©é—œã€‚", gift: "å‚³çµ±è¥¯è¡« (Ie)ã€å½©ç¹ªè›‹å·¥è—å“" },
            { day: 6, date: "12/23", country: "ä¿åŠ åˆ©äº", loc: "å¸ƒåŠ å‹’æ–¯ç‰¹ â å¤§å¡”çˆ¾è«¾æ²ƒ", tempH: 6, tempL: -2, weather: "æ¶¼å†·", desc: "é€²å…¥ä¿åŠ åˆ©äºã€‚æŸ¥é›·å¨èŒ²åŸå ¡ã€‚æ³¨æ„ã€é»é ­Noï¼Œæ–é ­Yesã€çš„ç‰¹æ®Šç¿’ä¿—ã€‚", tips: "è²¨å¹£ï¼šåˆ—å¼— (BGN)ã€‚", gift: "â˜…ç«ç‘°è£½å“(ç²¾æ²¹/è­·æ‰‹éœœ)ã€ç‰¹ç¾…æšé™¶ç“·" },
            { day: 7, date: "12/24", country: "ä¿åŠ åˆ©äº", loc: "å¡è´Šå‹’å…‹ â ç´¢è²äº", tempH: 4, tempL: -3, weather: "å¯’å†·", desc: "å¹³å®‰å¤œï¼é€ è¨ªç«ç‘°è°·ã€‚ç´¢è²äºå¸‚å€æœ‰éç¯€æ°£æ°›ï¼Œæ™šé¤å¾Œå•†åº—å¤šé—œé–€ã€‚", tips: "æ™šé¤ç¿’ä¿—åƒå¥‡æ•¸é“ç´ èœã€‚", gift: "ç«ç‘°è°·æ­£å®—ç«ç‘°ç”¢å“ã€ä¹³é…¸èŒè£½å“" },
            { day: 8, date: "12/25", country: "é¦¬å…¶é “", loc: "ç´¢è²äº â å²é«˜æ¯”è€¶", tempH: 8, tempL: -5, weather: "å±±å€å†·", desc: "è–èª•ç¯€å¿«æ¨‚ï¼åƒè§€é‡Œæ‹‰ä¿®é“é™¢(æ¥µèŠåš´ï¼Œå‹¿é–‹é–ƒå…‰ç‡ˆ)ã€‚é¦¬å…¶é “ä¸é12/25è–èª•ï¼Œå•†åº—ç…§é–‹ã€‚", tips: "è·¨å…¥åŒ—é¦¬å…¶é “ã€‚", gift: "ç„¡ç‰¹åˆ¥æ¨™è¨»ï¼Œå¯è²·é‡Œæ‹‰ä¿®é“é™¢ç´€å¿µå“" },
            { day: 9, date: "12/26", country: "ç§‘ç´¢æ²ƒ", loc: "å²é«˜æ¯”è€¶ â‡† æ™®åˆ©æ–¯ç·¹å¨œ", tempH: 5, tempL: -2, weather: "å¯’å†·", desc: "æ­æ´²æœ€å¹´è¼•åœ‹å®¶ã€‚æ”¿æ²»æ•æ„Ÿï¼Œé¿å…è«‡è«–å¡çˆ¾ç¶­äºé—œä¿‚ã€‚Newborn ç´€å¿µç¢‘ã€‚", tips: "ç§‘ç´¢æ²ƒç”¨æ­å…ƒï¼æ–¹ä¾¿è³¼ç‰©ã€‚", gift: "éŠ€çµ²å·¥è—å“ (Filigree)ã€Ajvar ç´…æ¤’é†¬" },
            { day: 10, date: "12/27", country: "é¦¬å…¶é “", loc: "å²é«˜æ¯”è€¶ â å¥§èµ«é‡Œå¾·", tempH: 7, tempL: 0, weather: "æ¿•å†·", desc: "å¥§èµ«é‡Œå¾·æ¹–(ä¸–ç•Œéºç”¢)ï¼Œå·´çˆ¾å¹¹çš„è€¶è·¯æ’’å†·ã€‚æ¹–å…‰å±±è‰²æ¥µç¾ã€‚", tips: "æ¹–é‚Šè¼ƒæ¿•å†·ï¼Œæ³¨æ„ä¿æš–ã€‚", gift: "â˜…å¥§èµ«é‡Œå¾·çç (å¿…è²·ï¼Œèªæ˜è­‰æ›¸)" },
            { day: 11, date: "12/28", country: "é˜¿çˆ¾å·´å°¼äº", loc: "å¥§èµ«é‡Œå¾· â ææ‹‰å¨œ", tempH: 12, tempL: 2, weather: "å¾®æº«", desc: "ç¢‰å ¡ç‹åœ‹ã€‚æ–¯åå¾·åŸ¹å»£å ´ã€‚å‚æ™šæœ‰ Xhiro æ•£æ­¥ç¿’æ…£ã€‚", tips: "è²¨å¹£ï¼šåˆ—å…‹ (Lek)ã€‚", gift: "ç¢‰å ¡é€ å‹ç…™ç°ç¼¸ã€Skanderbeg ç™½è˜­åœ°ã€æ©„æ¬–æ²¹" },
            { day: 12, date: "12/29", country: "è’™ç‰¹å…§å“¥ç¾…", loc: "ææ‹‰å¨œ â æ³¢å¾·å“¥é‡Œå¯Ÿ", tempH: 11, tempL: 3, weather: "æ¶¼çˆ½", desc: "å‰å¾€é»‘å±±å…±å’Œåœ‹é¦–éƒ½ã€‚åƒè§€åŸºç£å¾©æ´»å¤§æ•™å ‚ã€‚", tips: "è’™ç‰¹å…§å“¥ç¾…å–®æ–¹é¢ä½¿ç”¨æ­å…ƒã€‚", gift: "Vranac ç´…é…’" },
            { day: 13, date: "12/30", country: "æ³¢å£«å°¼äº", loc: "ç§‘æ‰˜çˆ¾ â è«æ–¯å¡”çˆ¾", tempH: 10, tempL: 2, weather: "å¤šé›¨", desc: "ç§‘æ‰˜çˆ¾ç£(è²“å’ªä¹‹åŸ)ã€‚è«æ–¯å¡”çˆ¾å¤æ©‹ï¼Œé«”é©—åœŸè€³å…¶é¢¨æƒ…ã€‚", tips: "å³½ç£å€å¤šé›¨ï¼Œé›¨å…·éš¨èº«ã€‚", gift: "è²“å’ªå·¥è—å“ã€éŠ…è£½å’–å•¡å…·ã€å½©ç¹ªç‡ˆé£¾" },
            { day: 14, date: "12/31", country: "å…‹ç¾…åŸƒè¥¿äº", loc: "å¡æ‹‰è€¶ä½› â å¥§è¥¿è€¶å…‹", tempH: 3, tempL: -3, weather: "å¯’å†·", desc: "åƒè§€å¡æ‹‰è€¶ä½›éŠ…åŒ è¡—ã€‚æ‹‰è»Šè‡³å…‹ç¾…åŸƒè¥¿äºè·¨å¹´ï¼è¶…å¸‚ä¸‹åˆé—œé–€è«‹æ—©å‚™è²¨ã€‚", tips: "å…‹ç¾…åŸƒè¥¿äºç”¨æ­å…ƒã€‚", gift: "å¡æ‹‰è€¶ä½›å­å½ˆç­†ã€éŠ…å™¨" },
            { day: 15, date: "1/1", country: "åŒˆç‰™åˆ©", loc: "å¥§è¥¿è€¶å…‹ â å¸ƒé”ä½©æ–¯", tempH: 3, tempL: -2, weather: "å¯’å†·", desc: "å…ƒæ—¦ï¼å•†åº—å¤šä¸é–‹ï¼Œå®‰æ’æˆ¶å¤–æ™¯é»ã€‚æ¬£è³å¤šç‘™æ²³å¤œæ™¯ã€‚", tips: "è¡Œç¨‹å°¾è²ï¼Œæ•´ç†æˆ°åˆ©å“ã€‚", gift: "KraÅ¡ å·§å…‹åŠ›ã€Licitar å¿ƒå‹è–‘é¤…ã€é ˜å¸¶" },
            { day: 16, date: "1/2", country: "è¿”ç¨‹", loc: "å¸ƒé”ä½©æ–¯ âœˆï¸", tempH: 4, tempL: -2, weather: "æ©Ÿä¸Š", desc: "å‰å¾€æ©Ÿå ´è¾¦ç†é€€ç¨…(è‹¥æœ‰é”é–€æª»)ã€‚å¸¶è‘—æ»¿æ»¿å›æ†¶å›å®¶ã€‚", tips: "é€€ç¨…ç‰©å“å»ºè­°æ”¾æ‰‹ææˆ–æ˜“æ‹¿è™•ã€‚", gift: "" },
            { day: 17, date: "1/3", country: "æŠµé”", loc: "ç”œèœœçš„å®¶", tempH: 20, tempL: 18, weather: "æº«æš–", desc: "å¹³å®‰æŠµé”å°ç£ã€‚æ³¨æ„å…¥å¢ƒå‹¿å¸¶è‚‰é¡ã€æ–°é®®è”¬æœã€‚", tips: "ä¼‘æ¯èª¿æ•´æ™‚å·®ã€‚", gift: "" }
        ];

        const checklistItems = [
            "â„ï¸ åšå¤–å¥— (ç¾½çµ¨è¡£)",
            "ğŸ§£ åœå·¾ã€æ¯›å¸½ã€æ‰‹å¥—",
            "ğŸ¥¾ é˜²æ»‘é˜²æ°´é‹",
            "ğŸ§´ ä¹³æ¶² & è­·å”‡è†",
            "ğŸ’Š å¸¸å‚™è—¥ (æšˆè»Š/è…¸èƒƒ)",
            "ğŸ”Œ é›™å­”åœ“è½‰æ¥é ­(220V)",
            "ğŸœ æ³¡éºµ/é›¶é£Ÿ",
            "ğŸ’¶ æ­å…ƒç¾é‡‘"
        ];

        const souvenirsList = [
            { name: "ç«ç‘°ç²¾æ²¹/ä¿é¤Šå“", country: "ä¿åŠ åˆ©äº", desc: "å¿…è²·é¦–é¸ï¼æ­£å®—ç«ç‘°ç”¢å“ã€‚", tags: ["cosmetic"] },
            { name: "å¥§èµ«é‡Œå¾·çç ", country: "é¦¬å…¶é “", desc: "äººé€ çç ï¼Œå…‰æ¾¤ç¨ç‰¹ï¼Œéœ€èªæ˜è­‰æ›¸ã€‚", tags: ["jewelry"] },
            { name: "Gerovital æŠ—è€éœœ", country: "ç¾…é¦¬å°¼äº", desc: "åœ‹å¯¶ç´šä¿é¤Šå“ï¼ŒCPå€¼æ¥µé«˜ã€‚", tags: ["cosmetic"] },
            { name: "ç´…æ¤’ç²‰ (Paprika)", country: "åŒˆç‰™åˆ©", desc: "ç¶“å…¸é¦™æ–™ï¼Œåˆ†ç”œè¾£å…©ç¨®ã€‚", tags: ["food"] },
            { name: "KraÅ¡ å·§å…‹åŠ›", country: "å…‹ç¾…åŸƒè¥¿äº", desc: "åœ‹æ°‘å“ç‰Œï¼ŒBajadera æœ€æœ‰åã€‚", tags: ["food"] },
            { name: "éŠ…è£½å’–å•¡å…·", country: "æ³¢å£«å°¼äº", desc: "åœŸè€³å…¶é¢¨æ ¼æ‰‹å·¥éŠ…å™¨ã€‚", tags: ["craft"] },
            { name: "ç‰¹ç¾…æšé™¶ç“·", country: "ä¿åŠ åˆ©äº", desc: "ç¨ç‰¹æ°´æ»´èŠ±ç´‹å½©ç¹ªé™¶å™¨ã€‚", tags: ["craft"] },
            { name: "éŠ€çµ²å·¥è—å“", country: "ç§‘ç´¢æ²ƒ/é¦¬å…¶é “", desc: "ç²¾ç´°éŠ€é£¾ï¼Œåƒ¹æ ¼è¦ªæ°‘ã€‚", tags: ["jewelry"] },
            { name: "Horezu é™¶ç“·", country: "ç¾…é¦¬å°¼äº", desc: "éç‰©è³ªæ–‡åŒ–éºç”¢ã€‚", tags: ["craft"] },
            { name: "Ajvar ç´…æ¤’é†¬", country: "é¦¬å…¶é “", desc: "ä½é¤ç¥é†¬ï¼Œé¦¬å…¶é “ç”¢æœ€å¥½åƒã€‚", tags: ["food"] },
            { name: "å­å½ˆç­†", country: "æ³¢å£«å°¼äº", desc: "å›æ”¶æˆ°æ™‚å½ˆæ®¼è£½æˆã€‚", tags: ["craft"] }
        ];

        const customsRules = {
            "è‚‰é¡è£½å“": { status: "stop", msg: "âŒ ç¦æ­¢ï¼é¦™è…¸/ç«è…¿/è‚‰ä¹¾/å«è‚‰ç½é ­çš†ä¸å¯å¸¶ã€‚" },
            "æ–°é®®è”¬æœ": { status: "stop", msg: "âŒ ç¦æ­¢ï¼æ–°é®®æ°´æœ/è”¬èœ/ç¨®å­ç¦æ­¢å…¥å¢ƒã€‚" },
            "å·§å…‹åŠ›/é¤…ä¹¾": { status: "go", msg: "âœ… å¯å¸¶ï¼åŠ å·¥é¤…ä¹¾ã€ç³–æœã€å·§å…‹åŠ›çš†å¯ã€‚" },
            "èµ·å¸/ä¹³è£½å“": { status: "caution", msg: "âš ï¸ æ³¨æ„ï¼å»ºè­°è²·ç¡¬èµ·å¸çœŸç©ºåŒ…è£ï¼Œç”Ÿä¹³è£½ç¦æ­¢ã€‚" },
            "é…’é¡": { status: "caution", msg: "âš ï¸ 18æ­²ä»¥ä¸Šå…ç¨…1å…¬å‡ã€‚ä¸Šé™5å…¬å‡éœ€ç”³å ±ã€‚" },
            "ç´…æ¤’ç²‰/é¦™æ–™": { status: "go", msg: "âœ… å¯å¸¶ï¼ä¹¾ç‡¥è™•ç†éçš„é¦™æ–™æ²’å•é¡Œã€‚" }
        };

        // --- GEMINI API CONFIGURATION ---
        const apiKey = ""; // Placeholder for runtime injection
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderChecklist();
            renderTimeline();
            renderCustomsFilters();
            renderSouvenirs(souvenirsList);
            selectDay(1); // Default to Day 1
            initCharts();
        });

        // --- NAVIGATION LOGIC ---
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Update Bottom Nav (Mobile)
            document.querySelectorAll('.bottom-nav-item').forEach(el => {
                if(el.dataset.target === tabId) {
                    el.classList.add('active', 'text-orange-700');
                    el.classList.remove('text-gray-400');
                    if(tabId === 'ai-assistant') el.querySelector('span').classList.add('text-purple-600');
                } else {
                    el.classList.remove('active', 'text-orange-700');
                    el.classList.add('text-gray-400');
                    if(el.dataset.target === 'ai-assistant') el.querySelector('span').classList.remove('text-purple-600');
                }
            });

            // Update Desktop Nav
            document.querySelectorAll('.desktop-nav-item').forEach(el => {
                if(el.dataset.target === tabId) {
                    el.classList.add('text-orange-700', 'font-bold');
                    el.classList.remove('text-gray-600');
                } else {
                    el.classList.remove('text-orange-700', 'font-bold');
                    el.classList.add('text-gray-600');
                }
            });

            // Re-render charts logic
            if (tabId === 'analytics') {
                setTimeout(initCharts, 100);
            }
        }

        // --- AI TAB LOGIC ---
        function switchAIMode(mode) {
            const chatBtn = document.getElementById('btn-ai-chat');
            const giftBtn = document.getElementById('btn-ai-gift');
            const chatView = document.getElementById('ai-mode-chat');
            const giftView = document.getElementById('ai-mode-gift');

            if (mode === 'chat') {
                chatBtn.classList.add('bg-white', 'shadow', 'text-purple-700', 'font-bold');
                chatBtn.classList.remove('text-gray-500', 'font-medium');
                giftBtn.classList.remove('bg-white', 'shadow', 'text-purple-700', 'font-bold');
                giftBtn.classList.add('text-gray-500', 'font-medium');
                
                chatView.classList.remove('hidden');
                giftView.classList.add('hidden');
            } else {
                giftBtn.classList.add('bg-white', 'shadow', 'text-purple-700', 'font-bold');
                giftBtn.classList.remove('text-gray-500', 'font-medium');
                chatBtn.classList.remove('bg-white', 'shadow', 'text-purple-700', 'font-bold');
                chatBtn.classList.add('text-gray-500', 'font-medium');

                giftView.classList.remove('hidden');
                chatView.classList.add('hidden');
            }
        }

        async function callGemini(prompt) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('Gemini Error:', error);
                if (error.name === 'AbortError') {
                    return "é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œå†è©¦ä¸€æ¬¡ã€‚";
                }
                return "æŠ±æ­‰ï¼ŒAI ç›®å‰ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            }
        }

        async function handleChat() {
            const inputEl = document.getElementById('chat-input');
            const submitBtn = document.getElementById('chat-submit');
            const historyEl = document.getElementById('chat-history');
            const userText = inputEl.value.trim();

            if (!userText) return;

            // UI Update: User Message
            inputEl.value = '';
            inputEl.disabled = true;
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
            
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble chat-user';
            userBubble.textContent = userText;
            historyEl.appendChild(userBubble);
            historyEl.scrollTop = historyEl.scrollHeight;

            // UI Update: Loading Bubble
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble chat-ai loading-dots';
            loadingBubble.textContent = 'æ€è€ƒä¸­';
            historyEl.appendChild(loadingBubble);
            historyEl.scrollTop = historyEl.scrollHeight;

            // Construct Prompt
            const itineraryContext = JSON.stringify(itineraryData.map(d => `Day ${d.day} (${d.date}): ${d.country} - ${d.loc}. Desc: ${d.desc}. Tips: ${d.tips}`));
            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å·´çˆ¾å¹¹åŠå³¶å°éŠã€‚ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚ä½ çš„å›ç­”æ‡‰è©²ç°¡æ½”ã€æœ‰è¶£ä¸”å¯¦ç”¨ã€‚è«‹åƒè€ƒä½¿ç”¨è€…çš„è¡Œç¨‹å…§å®¹ï¼š${itineraryContext}ã€‚ä½¿ç”¨è€…å•é¡Œï¼š${userText}`;

            // Call API
            const aiResponse = await callGemini(systemPrompt);

            // UI Update: AI Response
            historyEl.removeChild(loadingBubble);
            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble chat-ai markdown-body';
            aiBubble.innerHTML = marked.parse(aiResponse);
            historyEl.appendChild(aiBubble);
            historyEl.scrollTop = historyEl.scrollHeight;

            inputEl.disabled = false;
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50');
            inputEl.focus();
        }

        async function recommendGift() {
            const recipient = document.getElementById('gift-recipient').value;
            const country = document.getElementById('gift-country').value;
            const resultDiv = document.getElementById('gift-result');
            const contentDiv = document.getElementById('gift-content');
            const submitBtn = document.getElementById('gift-submit');

            if (!recipient) {
                alert("è«‹è¼¸å…¥é€ç¦®å°è±¡ï¼");
                return;
            }

            // UI Loading
            submitBtn.disabled = true;
            submitBtn.textContent = "âœ¨ æ­£åœ¨ç‚ºæ‚¨æŒ‘é¸...";
            resultDiv.classList.remove('hidden');
            contentDiv.innerHTML = '<div class="text-center py-4 loading-dots text-purple-600">AI æ­£åœ¨åˆ†ææœ€é©åˆçš„ç¦®ç‰©</div>';

            // Construct Prompt
            const souvenirsContext = JSON.stringify(souvenirsList);
            const prompt = `ä½ æ˜¯ä¸€ä½å·´çˆ¾å¹¹åŠå³¶ç´€å¿µå“å°ˆå®¶ã€‚ä½¿ç”¨è€…æƒ³é€ç¦®çµ¦ã€Œ${recipient}ã€ï¼Œç¯„åœæ˜¯ã€Œ${country}ã€ã€‚è«‹å¾ä»¥ä¸‹æ¸…å–®æˆ–ä½ çš„çŸ¥è­˜åº«ä¸­ï¼Œæ¨è–¦ 2-3 å€‹æœ€é©åˆçš„ç¦®ç‰©ï¼Œä¸¦ç”¨æº«æš–çš„èªæ°£è§£é‡‹åŸå› ã€‚è«‹ä½¿ç”¨ Markdown æ ¼å¼æ¢åˆ—ã€‚åƒè€ƒæ¸…å–®ï¼š${souvenirsContext}`;

            // Call API
            const aiResponse = await callGemini(prompt);

            // Display Result
            contentDiv.innerHTML = marked.parse(aiResponse);
            submitBtn.disabled = false;
            submitBtn.textContent = "âœ¨ ç”Ÿæˆæ¨è–¦æ¸…å–®";
        }

        // --- DASHBOARD FUNCTIONS ---
        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = checklistItems.map((item) => `
                <div class="flex items-center p-3 bg-gray-50 rounded-lg active:bg-orange-50 cursor-pointer transition select-none" onclick="toggleCheck(this)">
                    <div class="w-6 h-6 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center text-white font-bold text-xs check-box transition-colors">âœ“</div>
                    <span class="text-gray-700 text-sm font-medium">${item}</span>
                </div>
            `).join('');
        }

        function toggleCheck(el) {
            const box = el.querySelector('.check-box');
            if (box.classList.contains('bg-green-500')) {
                box.classList.remove('bg-green-500', 'border-green-500');
                box.classList.add('border-gray-300');
                el.classList.remove('bg-green-50', 'border-green-100');
            } else {
                box.classList.add('bg-green-500', 'border-green-500');
                box.classList.remove('border-gray-300');
                el.classList.add('bg-green-50', 'border-green-100');
            }
            updateProgress();
        }

        function updateProgress() {
            const checked = document.querySelectorAll('.check-box.bg-green-500').length;
            const total = checklistItems.length;
            document.getElementById('progress-text').innerText = `${checked}/${total}`;
        }

        // --- ITINERARY FUNCTIONS ---
        function renderTimeline() {
            const container = document.getElementById('timeline-scroll');
            container.innerHTML = itineraryData.map((day) => `
                <div onclick="selectDay(${day.day})" id="day-card-${day.day}" class="flex-shrink-0 w-20 flex flex-col items-center justify-center py-2 px-1 rounded-xl transition-all cursor-pointer day-card border border-transparent">
                    <span class="text-[10px] font-bold text-gray-400 mb-1">D${day.day}</span>
                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-sm font-bold text-gray-600 mb-1 date-circle">${day.date.split('/')[1]}</div>
                </div>
            `).join('');
        }

        function selectDay(dayNum) {
            const data = itineraryData.find(d => d.day === dayNum);
            
            // Update Visuals
            document.querySelectorAll('.day-card').forEach(el => {
                el.classList.remove('active-day');
                el.querySelector('.date-circle').classList.remove('bg-orange-500', 'text-white');
                el.querySelector('.date-circle').classList.add('bg-gray-100', 'text-gray-600');
            });
            
            const activeCard = document.getElementById(`day-card-${dayNum}`);
            if(activeCard) {
                activeCard.classList.add('active-day');
                activeCard.querySelector('.date-circle').classList.remove('bg-gray-100', 'text-gray-600');
                activeCard.querySelector('.date-circle').classList.add('bg-orange-500', 'text-white');
                activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            // Render Detail
            const detailContainer = document.getElementById('day-detail');
            
            // Gift logic
            let giftSection = '';
            if (data.gift) {
                giftSection = `
                    <div class="mt-4 p-3 bg-pink-50 rounded-lg border border-pink-100">
                        <h4 class="font-bold text-pink-700 mb-1 text-sm flex items-center"><span class="mr-1">ğŸ›ï¸</span> è³¼ç‰©æ¨è–¦</h4>
                        <p class="text-xs text-gray-700 leading-relaxed">${data.gift}</p>
                    </div>
                `;
            }

            detailContainer.innerHTML = `
                <div class="relative h-32 bg-gradient-to-br from-orange-500 to-red-500 text-white p-5 overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-9xl opacity-10 font-bold">${data.day}</div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs bg-white/20 px-2 py-0.5 rounded backdrop-blur-sm">${data.date}</span>
                            <div class="text-right">
                                <span class="text-2xl font-bold">${data.tempH}Â°</span>
                                <span class="text-sm opacity-80">/ ${data.tempL}Â°</span>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold leading-tight mt-1">${data.country}</h3>
                        <p class="text-xs opacity-90 mt-1 truncate">${data.loc}</p>
                    </div>
                </div>
                <div class="p-5">
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 leading-relaxed">${data.desc}</p>
                    </div>
                    <div class="space-y-3">
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <h4 class="font-bold text-blue-800 mb-1 text-sm flex items-center"><span class="mr-1">ğŸ’¡</span> è²¼å¿ƒæé†’</h4>
                            <p class="text-xs text-gray-700 leading-relaxed">${data.tips}</p>
                        </div>
                        ${giftSection}
                    </div>
                </div>
            `;
        }

        // --- SOUVENIRS FUNCTIONS ---
        function renderCustomsFilters() {
            const container = document.getElementById('customs-filters');
            container.innerHTML = Object.keys(customsRules).map(key => `
                <button onclick="checkCustoms('${key}')" class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-gray-600 active:bg-gray-100 text-xs font-medium transition shadow-sm">
                    ${key}
                </button>
            `).join('');
        }

        function checkCustoms(key) {
            const rule = customsRules[key];
            const resultBox = document.getElementById('customs-result');
            
            let colorClass = "bg-gray-50 border-gray-200 text-gray-700";
            if (rule.status === 'stop') colorClass = "bg-red-50 border-red-200 text-red-800";
            if (rule.status === 'caution') colorClass = "bg-yellow-50 border-yellow-200 text-yellow-800";
            if (rule.status === 'go') colorClass = "bg-green-50 border-green-200 text-green-800";

            resultBox.className = `p-4 rounded-lg border text-center transition-all ${colorClass}`;
            resultBox.innerHTML = `<span class="font-bold text-sm block">${rule.msg}</span>`;
        }

        function renderSouvenirs(list) {
            const container = document.getElementById('souvenir-grid');
            container.innerHTML = list.map(item => `
                <div class="bg-white rounded-lg p-4 border border-gray-100 shadow-sm flex items-start souvenir-item active:scale-[0.99] transition-transform" data-country="${item.country}">
                    <div class="w-1 h-12 bg-gradient-to-b from-purple-400 to-pink-500 rounded-full mr-3 flex-shrink-0"></div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-bold text-gray-800 text-sm">${item.name}</h3>
                            <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">${item.country}</span>
                        </div>
                        <p class="text-xs text-gray-500 leading-tight mb-2">${item.desc}</p>
                        <div class="flex gap-1 flex-wrap">
                            ${item.tags.map(t => `<span class="text-[10px] text-gray-400">#${t}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterSouvenirs(country) {
            document.querySelectorAll('#souvenirs button[id^="filter-"]').forEach(btn => {
                if(btn.id === `filter-${country}`) {
                     btn.classList.remove('bg-gray-100', 'text-gray-600');
                     btn.classList.add('bg-purple-600', 'text-white', 'shadow-md');
                } else {
                     btn.classList.add('bg-gray-100', 'text-gray-600');
                     btn.classList.remove('bg-purple-600', 'text-white', 'shadow-md');
                }
            });

            const items = document.querySelectorAll('.souvenir-item');
            items.forEach(item => {
                if (country === 'all' || item.dataset.country.includes(country)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // --- CHARTS ---
        let tempChartInstance = null;
        let currencyChartInstance = null;

        function initCharts() {
            // Temperature
            const ctxTemp = document.getElementById('tempChart');
            if (ctxTemp) {
                if (tempChartInstance) tempChartInstance.destroy();
                const labels = itineraryData.map(d => `D${d.day}`);
                const highs = itineraryData.map(d => d.tempH);
                const lows = itineraryData.map(d => d.tempL);

                tempChartInstance = new Chart(ctxTemp, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'é«˜æº«', data: highs, borderColor: '#DD6B20', backgroundColor: 'rgba(221, 107, 32, 0.1)', tension: 0.4, borderWidth: 2, pointRadius: 2 },
                            { label: 'ä½æº«', data: lows, borderColor: '#3182CE', backgroundColor: 'rgba(49, 130, 206, 0.1)', tension: 0.4, borderWidth: 2, pointRadius: 2, fill: true }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', labels: { boxWidth: 10, font: { size: 10 } } } },
                        scales: { y: { display: true, grid: { color: '#f5f5f5' } }, x: { display: false } }
                    }
                });
            }

            // Currency
            const ctxCurr = document.getElementById('currencyChart');
            if (ctxCurr) {
                if (currencyChartInstance) currencyChartInstance.destroy();
                currencyChartInstance = new Chart(ctxCurr, {
                    type: 'doughnut',
                    data: {
                        labels: ['æ­å…ƒ', 'åˆ—ä¼Š(ç¾…)', 'åˆ—å¼—(ä¿)', 'ç¦æ—(åŒˆ)', 'å…¶ä»–'],
                        datasets: [{
                            data: [3, 3, 2, 2, 5],
                            backgroundColor: ['#3182CE', '#D69E2E', '#E53E3E', '#38A169', '#805AD5'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
                    }
                });
            }
        }
    </script>
</body>
</html>
